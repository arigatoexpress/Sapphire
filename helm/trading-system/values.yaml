# Default values for trading-system helm chart
global:
  imageRegistry: us-central1-docker.pkg.dev
  projectId: sapphireinfinite
  imagePullPolicy: Always

# Vertex AI and TPU configuration - Full Google AI optimization
vertexAI:
  enabled: true
  project: "sapphireinfinite"
  location: "us-central1"
  orchestrator:
    enabled: true
    endpoint: "https://us-central1-aiplatform.googleapis.com/v1/projects/sapphireinfinite/locations/us-central1/endpoints/mcp-orchestrator-endpoint"
    model: "gemini-1.5-pro"  # Advanced orchestrator for MCP coordination
  mlops:
    enabled: true
    experimentTracking: true
    modelMonitoring: true
    performanceMetrics: true
    driftDetection: true

tpu:
  enabled: false  # Set to true after TPU quota approval
  type: "v5e-lite-podslice"  # Most cost-effective TPU for inference
  machineType: "ct5lp-hightpu-1t"  # TPU v5e instance
  optimization:
    bfloat16: true  # Enable mixed precision for TPU efficiency
    xlaCompilation: true  # Enable XLA compilation for TPU
    dynamicPadding: false  # Static shapes for TPU optimization
  # TPU v5e pricing: ~$1.20/hour vs L4 GPU ~$1.50/hour
  # Performance: 197 TFLOPS optimized for transformer inference

# Redis configuration
redis:
  enabled: true
  architecture: standalone
  auth:
    enabled: false
  master:
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 1Gi
  replica:
    replicaCount: 1
    resources:
      requests:
        cpu: 50m
        memory: 128Mi
      limits:
        cpu: 200m
        memory: 512Mi
  metrics:
    enabled: true
  persistence:
    enabled: true
    size: 8Gi
  redisConfig:
    maxmemory: "512mb"
    maxmemory-policy: "allkeys-lru"
    tcp-keepalive: "60"
    timeout: "300"
    databases: "16"
    appendonly: "yes"
    appendfsync: "everysec"

# Cloud Trader API Service
cloudTrader:
  enabled: true
  replicaCount: 2
  image:
    repository: cloud-run-source-deploy/cloud-trader
    tag: "latest"
  service:
    type: ClusterIP
    port: 8080
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 1Gi
  env:
    - name: ENABLE_PAPER_TRADING
      value: "true"
    - name: LOG_LEVEL
      value: "WARNING"
    - name: MCP_ENABLED
      value: "true"
    - name: TELEGRAM_BOT_TOKEN
      value: ""  # Will be overridden by secret
    - name: TELEGRAM_CHAT_ID
      value: ""  # Will be overridden by secret

# MCP Coordinator Service - Vertex AI Orchestrator
mcpCoordinator:
  enabled: true
  replicaCount: 1
  image:
    repository: cloud-run-source-deploy/cloud-trader
    tag: "latest"
  service:
    type: ClusterIP
    port: 8081
  # Vertex AI Orchestration for Advanced MCP Coordination
  vertexAI:
    model: "gemini-1.5-pro"  # Advanced orchestrator for multi-agent coordination
    optimization:
      quantization: "int8"  # Efficient for orchestration tasks
      batchSize: 1  # Single orchestration decisions
      temperature: 0.1  # High precision for coordination
      maxTokens: 2048  # Complex coordination analysis
    roleContext: "mcp-orchestrator"
    monitoring:
      latencyThreshold: 300  # 300ms target for orchestration decisions
      accuracyMetric: "coordination_success_rate"
      driftThreshold: 0.04
  resources:
    requests:
      cpu: 1000m  # Increased for Vertex AI orchestration
      memory: 2Gi  # Increased for complex coordination state
    limits:
      cpu: 2000m  # Higher CPU for concurrent AI coordination
      memory: 4Gi  # Increased memory for orchestration state
  env:
    - name: LOG_LEVEL
      value: "INFO"
    - name: MCP_ENABLED
      value: "true"
    - name: MESSAGE_COMPRESSION
      value: "true"  # Enable message compression
    - name: CONNECTION_POOL_SIZE
      value: "50"  # Larger connection pool
    - name: MESSAGE_BATCH_SIZE
      value: "100"  # Batch message processing
    - name: ASYNC_WORKERS
      value: "16"  # Concurrent message handlers
    - name: MEMORY_CACHE_ENABLED
      value: "true"  # Enable in-memory caching

# LLM Agent Services
agents:
  enabled: true

  # DeepSeek Agent - Momentum Analysis Specialist (Vertex AI Optimized)
  deepseek:
    enabled: true
    replicaCount: 1
    image:
      repository: cloud-run-source-deploy/cloud-trader
      tag: "latest"
    resources:
      requests:
        cpu: 1000m
        memory: 4Gi
      limits:
        cpu: 3000m
        memory: 12Gi
    # Vertex AI Optimization for Momentum Analysis
    vertexAI:
      model: "gemini-1.5-flash"  # Fast inference for real-time momentum
      optimization:
        quantization: "int8"  # Efficient for momentum calculations
        batchSize: 8
        temperature: 0.1  # Low creativity, high precision
        maxTokens: 512  # Concise momentum analysis
      roleContext: "momentum-analysis"
      monitoring:
        latencyThreshold: 200  # 200ms target for momentum signals
        accuracyMetric: "momentum_prediction_accuracy"
        driftThreshold: 0.05
    env:
      - name: ENABLE_PAPER_TRADING
        value: "true"
      - name: ENABLED_AGENTS
        value: '["deepseek-v3"]'
      - name: ENABLE_VERTEX_AI
        value: "true"
      - name: MCP_ENABLED
        value: "true"
      - name: AGENT_ROLE
        value: "momentum-analysis"
      - name: VERTEX_MODEL
        value: "gemini-1.5-flash"
      - name: MODEL_TEMPERATURE
        value: "0.1"
      - name: MAX_OUTPUT_TOKENS
        value: "512"
      - name: QUANTIZATION_LEVEL
        value: "int8"
      - name: MONITORING_ENABLED
        value: "true"
    env:
      - name: ENABLE_PAPER_TRADING
        value: "true"
      - name: ENABLED_AGENTS
        value: '["deepseek-v3"]'
      - name: ENABLE_VERTEX_AI
        value: "true"
      - name: MCP_ENABLED
        value: "true"
      - name: AGENT_ROLE
        value: "momentum-analysis"
      - name: VERTEX_MODEL
        value: "gemini-1.5-flash"
      - name: MODEL_TEMPERATURE
        value: "0.1"
      - name: MAX_OUTPUT_TOKENS
        value: "512"
      - name: QUANTIZATION_LEVEL
        value: "int8"
      - name: MONITORING_ENABLED
        value: "true"

  # Qwen Agent - Strategy Optimization Specialist (Vertex AI Optimized)
  qwen:
    enabled: true
    replicaCount: 1
    image:
      repository: cloud-run-source-deploy/cloud-trader
      tag: "latest"
    resources:
      requests:
        cpu: 1000m
        memory: 4Gi
      limits:
        cpu: 3000m
        memory: 12Gi
    # Vertex AI Optimization for Strategy Optimization
    vertexAI:
      model: "gemini-1.5-pro"  # Advanced reasoning for strategy optimization
      optimization:
        quantization: "int8"  # Balanced precision/performance
        batchSize: 4  # Smaller batches for complex reasoning
        temperature: 0.3  # Moderate creativity for strategy innovation
        maxTokens: 1024  # Detailed strategy analysis
      roleContext: "strategy-optimization"
      monitoring:
        latencyThreshold: 500  # 500ms acceptable for strategy decisions
        accuracyMetric: "strategy_success_rate"
        driftThreshold: 0.08
    env:
      - name: ENABLE_PAPER_TRADING
        value: "true"
      - name: ENABLED_AGENTS
        value: '["qwen-adaptive"]'
      - name: ENABLE_VERTEX_AI
        value: "true"
      - name: MCP_ENABLED
        value: "true"
      - name: AGENT_ROLE
        value: "strategy-optimization"
      - name: VERTEX_MODEL
        value: "gemini-1.5-pro"
      - name: MODEL_TEMPERATURE
        value: "0.3"
      - name: MAX_OUTPUT_TOKENS
        value: "1024"
      - name: QUANTIZATION_LEVEL
        value: "int8"
      - name: MONITORING_ENABLED
        value: "true"

  # FinGPT Agent - Financial Sentiment Analysis Specialist (Vertex AI Optimized)
  fingpt:
    enabled: true
    replicaCount: 1
    image:
      repository: cloud-run-source-deploy/cloud-trader
      tag: "latest"
    resources:
      requests:
        cpu: 1000m
        memory: 4Gi
      limits:
        cpu: 3000m
        memory: 12Gi
    # Vertex AI Optimization for Sentiment Analysis
    vertexAI:
      model: "gemini-1.5-flash"  # Fast inference for real-time sentiment
      optimization:
        quantization: "int8"  # Efficient for text analysis
        batchSize: 16  # Higher batches for sentiment processing
        temperature: 0.2  # Low creativity for consistent sentiment
        maxTokens: 256  # Concise sentiment scores
      roleContext: "sentiment-analysis"
      monitoring:
        latencyThreshold: 150  # 150ms target for sentiment signals
        accuracyMetric: "sentiment_accuracy"
        driftThreshold: 0.03
    env:
      - name: ENABLE_PAPER_TRADING
        value: "true"
      - name: ENABLED_AGENTS
        value: '["fingpt-alpha"]'
      - name: ENABLE_VERTEX_AI
        value: "true"
      - name: MCP_ENABLED
        value: "true"
      - name: AGENT_ROLE
        value: "sentiment-analysis"
      - name: VERTEX_MODEL
        value: "gemini-1.5-flash"
      - name: MODEL_TEMPERATURE
        value: "0.2"
      - name: MAX_OUTPUT_TOKENS
        value: "256"
      - name: QUANTIZATION_LEVEL
        value: "int8"
      - name: MONITORING_ENABLED
        value: "true"

  # Lag-LLaMA Agent - DeFi Market Prediction Specialist (Vertex AI Optimized)
  lagllama:
    enabled: true
    replicaCount: 1
    image:
      repository: cloud-run-source-deploy/cloud-trader
      tag: "latest"
    resources:
      requests:
        cpu: 1000m
        memory: 4Gi
      limits:
        cpu: 3000m
        memory: 12Gi
    # Vertex AI Optimization for DeFi Prediction
    vertexAI:
      model: "gemini-1.5-pro"  # Advanced reasoning for market prediction
      optimization:
        quantization: "int8"  # Balanced for complex DeFi analysis
        batchSize: 6  # Medium batches for prediction models
        temperature: 0.4  # Moderate creativity for market scenarios
        maxTokens: 768  # Detailed prediction analysis
      roleContext: "defi-prediction"
      monitoring:
        latencyThreshold: 400  # 400ms acceptable for prediction analysis
        accuracyMetric: "prediction_accuracy"
        driftThreshold: 0.06
    env:
      - name: ENABLE_PAPER_TRADING
        value: "true"
      - name: ENABLED_AGENTS
        value: '["lagllama-degen"]'
      - name: ENABLE_VERTEX_AI
        value: "true"
      - name: MCP_ENABLED
        value: "true"
      - name: AGENT_ROLE
        value: "defi-prediction"
      - name: VERTEX_MODEL
        value: "gemini-1.5-pro"
      - name: MODEL_TEMPERATURE
        value: "0.4"
      - name: MAX_OUTPUT_TOKENS
        value: "768"
      - name: QUANTIZATION_LEVEL
        value: "int8"
      - name: MONITORING_ENABLED
        value: "true"

  # VPIN Agent (TPU-accelerated with elastic scaling and fallback - cost-optimized)
  vpin:
    enabled: true
    replicaCount: 1
    image:
      repository: cloud-run-source-deploy/cloud-trader
      tag: "latest"
    resources:
      requests:
        cpu: 1000m
        memory: 4Gi
        google.com/tpu: "1"  # TPU resource instead of GPU
      limits:
        cpu: 3000m
        memory: 12Gi
        google.com/tpu: "1"  # TPU resource instead of GPU
    env:
      - name: ENABLE_PAPER_TRADING
        value: "true"
      - name: ENABLED_AGENTS
        value: '["vpin-hft"]'
      - name: ENABLE_VERTEX_AI
        value: "true"
      - name: MCP_ENABLED
        value: "true"
      - name: VPIN_VERTEX_ENDPOINT
        value: "https://us-central1-aiplatform.googleapis.com/v1/projects/sapphireinfinite/locations/us-central1/endpoints/vpin-hft-endpoint"
      - name: MODEL_QUANTIZATION
        value: "4bit"
      - name: TPU_IP_ADDRESS
        value: ""  # Will be set by TPU runtime
      - name: TPU_NAME
        value: "vpin-tpu"  # TPU instance name
      - name: USE_TPU
        value: "true"  # Enable TPU mode instead of GPU
      - name: XRT_TPU_CONFIG
        value: "localservice;0;localhost:51011"  # TPU runtime config
      - name: INFERENCE_BATCH_SIZE
        value: "32"   # TPU optimized batch size (larger than GPU)
      - name: TPU_PROFILER_PORT
        value: "8466"  # TPU profiling port
      # Elastic scaling and fallback configuration
      - name: ELASTIC_SCALING_ENABLED
        value: "true"
      - name: FALLBACK_MODELS
        value: '["deepseek-v3", "qwen-adaptive", "fingpt-alpha"]'
      - name: API_THROTTLE_DETECTION_ENABLED
        value: "true"
      - name: THROTTLE_THRESHOLD_REQUESTS
        value: "10"  # Requests per minute threshold
      - name: THROTTLE_BACKOFF_SECONDS
        value: "300"  # 5 minutes backoff when throttled
      - name: RESOURCE_CONSERVATION_MODE
        value: "true"  # Scale down when throttled
      - name: FALLBACK_ACCURACY_THRESHOLD
        value: "0.85"  # Minimum acceptable accuracy for fallback models

# Trading Framework Services
frameworks:
  enabled: true

  # Freqtrade HFT
  freqtrade:
    enabled: true
    replicaCount: 1
    image:
      repository: cloud-run-source-deploy/freqtrade
      tag: "latest"
    resources:
      requests:
        cpu: 750m  # Optimized for vectorized operations
        memory: 1.5Gi  # Reduced with memory optimization
      limits:
        cpu: 3000m  # Increased for parallel processing
        memory: 6Gi
    env:
      - name: ENABLE_PAPER_TRADING
        value: "true"
      - name: FREQTRADE__EXCHANGE__NAME
        value: "asterdex"
      - name: FREQTRADE__TELEGRAM__ENABLED
        value: "true"
      - name: NUMBA_THREADING_LAYER
        value: "omp"  # Optimize Numba threading
      - name: OMP_NUM_THREADS
        value: "4"  # Parallel computation threads
      - name: PYTHONOPTIMIZE
        value: "1"  # Enable Python optimizations
      - name: VECTORIZE_OPERATIONS
        value: "true"  # Enable SIMD vectorization

  # Hummingbot Market Maker
  hummingbot:
    enabled: true
    replicaCount: 1
    image:
      repository: cloud-run-source-deploy/hummingbot
      tag: "latest"
    resources:
      requests:
        cpu: 500m  # Optimized resource usage
        memory: 1Gi  # Increased for market data caching
      limits:
        cpu: 2000m
        memory: 4Gi
    env:
      - name: ENABLE_PAPER_TRADING
        value: "true"
      - name: HUMMINGBOT__TELEGRAM__ENABLED
        value: "true"
      - name: ASYNC_IO_WORKERS
        value: "8"  # Optimize async I/O
      - name: CONNECTION_POOL_SIZE
        value: "20"  # Connection pooling
      - name: MEMORY_CACHE_SIZE
        value: "512MB"  # In-memory cache size
      - name: NETWORK_TIMEOUT
        value: "5"  # Reduced network timeout

# Horizontal Pod Autoscaling
hpa:
  enabled: true

  # VPIN HPA (Elastic scaling with intelligent resource management)
  vpin:
    enabled: true
    minReplicas: 0  # Can scale to zero when throttled
    maxReplicas: 3
    targetCPUUtilizationPercentage: 60  # Lower threshold for GPU workloads
    targetMemoryUtilizationPercentage: 75
    # Custom metrics for intelligent scaling
    customMetrics:
      - type: Pods
        pods:
          metric:
            name: api_requests_per_second
          target:
            type: AverageValue
            averageValue: 5  # Scale up if >5 req/sec
      - type: Pods
        pods:
          metric:
            name: throttle_rate
          target:
            type: AverageValue
            averageValue: 0.1  # Scale down if throttle rate >10%

  # Freqtrade HPA
  freqtrade:
    enabled: true
    minReplicas: 1
    maxReplicas: 3
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80

  # Hummingbot HPA
  hummingbot:
    enabled: true
    minReplicas: 1
    maxReplicas: 2
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80

# Monitoring and Observability
monitoring:
  enabled: true
  prometheus:
    enabled: true
    scrapeInterval: 15s
    evaluationInterval: 15s
    retention: 30d
  grafana:
    enabled: true
    adminPassword: "sapphire-trading-2024"  # Change in production
    dashboards:
      enabled: true
      default: true
  alertmanager:
    enabled: true
    slackWebhookUrl: ""  # Configure for production alerts

# Logging Configuration
logging:
  level: "INFO"
  format: "json"
  fluentd:
    enabled: true
    match: "kube.*"
  elasticsearch:
    enabled: false  # Enable if needed for log aggregation

# Security and Compliance
security:
  networkPolicies:
    enabled: true
  podSecurityStandards:
    enabled: true
    level: "restricted"
  secrets:
    encryption: true
  audit:
    enabled: true
    logRetention: 90d

# Service Account for GCP access
serviceAccount:
  create: true
  name: trading-system-sa
  annotations:
    iam.gke.io/gcp-service-account: trading-system@sapphireinfinite.iam.gserviceaccount.com

# Security Context
securityContext:
  runAsNonRoot: true
  runAsUser: 1000
  fsGroup: 2000

# Node Selector for TPU nodes (only used when tpu.enabled=true)
nodeSelector:
  cloud.google.com/gke-tpu-accelerator: v5-lite-podslice
  cloud.google.com/gke-tpu-topology: "1"
  instance-type: ct5lp-hightpu-1t

# Tolerations for TPU workloads (only used when tpu.enabled=true)
tolerations:
  - key: "google.com/tpu"
    operator: "Exists"
    effect: "NoSchedule"

# Affinity rules
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
    - weight: 100
      podAffinityTerm:
        labelSelector:
          matchExpressions:
          - key: app
            operator: In
            values:
            - cloud-trader
            - freqtrade-hft
            - hummingbot-mm
        topologyKey: kubernetes.io/hostname

# System Initialization Job
systemInitialization:
  enabled: true
  image:
    repository: cloud-run-source-deploy/cloud-trader
    tag: "latest"
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi
